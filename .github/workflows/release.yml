name: Release

on:
  push:
    tags:
      - "v*"

permissions:
  contents: write

jobs:
  build-archives:
    name: Build archives (${{ matrix.target }})
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-latest
            target: x86_64-unknown-linux-gnu
            archive_ext: tar.gz
            bin: debaser
          - os: macos-latest
            target: aarch64-apple-darwin
            archive_ext: tar.gz
            bin: debaser

          - os: windows-latest
            target: x86_64-pc-windows-msvc
            archive_ext: zip
            bin: debaser.exe
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@1.92.0
        with:
          targets: ${{ matrix.target }}

      - name: Cache Rust builds
        uses: Swatinem/rust-cache@v2

      - name: Test
        run: cargo test --locked

      - name: Build
        run: cargo build --release --locked --target ${{ matrix.target }}

      - name: Package (unix)
        if: runner.os != 'Windows'
        shell: bash
        run: |
          set -euo pipefail
          dir="debaser-${GITHUB_REF_NAME}-${{ matrix.target }}"
          asset="${dir}.${{ matrix.archive_ext }}"
          mkdir -p "$dir"
          cp "target/${{ matrix.target }}/release/${{ matrix.bin }}" "$dir/"
          cp LICENSE README.md "$dir/"
          tar -czf "$asset" "$dir"
          echo "ASSET=$asset" >> "$GITHUB_ENV"

      - name: Package (windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          $dir = "debaser-$env:GITHUB_REF_NAME-${{ matrix.target }}"
          $asset = "$dir.${{ matrix.archive_ext }}"
          New-Item -ItemType Directory -Force -Path $dir | Out-Null
          Copy-Item "target\\${{ matrix.target }}\\release\\${{ matrix.bin }}" "$dir\\${{ matrix.bin }}" -Force
          Copy-Item "LICENSE" "$dir\\LICENSE" -Force
          Copy-Item "README.md" "$dir\\README.md" -Force
          Compress-Archive -Path "$dir\\*" -DestinationPath $asset -Force
          "ASSET=$asset" | Out-File -FilePath $env:GITHUB_ENV -Append -Encoding utf8

      - name: Upload archive artifact
        uses: actions/upload-artifact@v4
        with:
          name: release-archive-${{ matrix.target }}
          path: ${{ env.ASSET }}

  linux-packages:
    name: Build .deb/.rpm + repos
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@1.92.0
        with:
          targets: x86_64-unknown-linux-gnu

      - name: Cache Rust builds
        uses: Swatinem/rust-cache@v2

      - name: Install system deps
        run: |
          set -euo pipefail
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends \
            createrepo-c \
            gnupg \
            reprepro

      - name: Install cargo packaging tools
        run: |
          set -euo pipefail
          cargo install cargo-deb --locked
          cargo install cargo-generate-rpm --locked

      - name: Verify tag matches Cargo.toml
        shell: bash
        run: |
          set -euo pipefail
          tag="${GITHUB_REF_NAME}"
          version="${tag#v}"
          cargo_version="$(cargo metadata --no-deps --format-version=1 | python3 -c 'import json,sys; print(json.load(sys.stdin)["packages"][0]["version"])')"
          if [[ "$version" != "$cargo_version" ]]; then
            echo "Tag version ($version) does not match Cargo.toml version ($cargo_version)" >&2
            exit 1
          fi

      - name: Import GPG signing key
        env:
          GPG_PRIVATE_KEY: ${{ secrets.GPG_PRIVATE_KEY }}
        run: |
          set -euo pipefail
          if [[ -z "${GPG_PRIVATE_KEY}" ]]; then
            echo "Missing GPG_PRIVATE_KEY secret" >&2
            exit 1
          fi
          printf '%s' "${GPG_PRIVATE_KEY}" | base64 --decode | gpg --batch --import
          gpg --list-secret-keys --keyid-format LONG

      - name: Resolve GPG key id
        shell: bash
        run: |
          set -euo pipefail
          key_id="$(gpg --list-secret-keys --with-colons | awk -F: '$1=="fpr" {print $10; exit}')"
          if [[ -z "$key_id" ]]; then
            echo "Failed to resolve GPG key id" >&2
            exit 1
          fi
          echo "GPG_KEY_ID=$key_id" >> "$GITHUB_ENV"

      - name: Build .deb
        run: ./scripts/packaging/build-deb.sh --target x86_64-unknown-linux-gnu --out-dir dist

      - name: Build .rpm
        run: ./scripts/packaging/build-rpm.sh --target x86_64-unknown-linux-gnu --out-dir dist

      - name: Build signed APT repo
        env:
          GPG_PASSPHRASE: ${{ secrets.GPG_PASSPHRASE }}
        run: |
          set -euo pipefail
          ./scripts/packaging/build-apt-repo.sh \
            --repo-dir dist/apt \
            --codename stable \
            --architectures amd64 \
            --gpg-key-id "$GPG_KEY_ID" \
            --deb dist/*.deb

      - name: Build signed RPM repo
        env:
          GPG_PASSPHRASE: ${{ secrets.GPG_PASSPHRASE }}
        run: |
          set -euo pipefail
          ./scripts/packaging/build-rpm-repo.sh \
            --repo-dir dist/rpm \
            --sign \
            --gpg-key-id "$GPG_KEY_ID" \
            --rpm dist/*.rpm

      - name: Export public key
        shell: bash
        run: |
          set -euo pipefail
          gpg --batch --yes --armor --output dist/public.gpg --export "$GPG_KEY_ID"

      - name: Archive repos (for release assets)
        shell: bash
        run: |
          set -euo pipefail
          tar -C dist -czf "apt-repo-${GITHUB_REF_NAME}.tar.gz" apt
          tar -C dist -czf "rpm-repo-${GITHUB_REF_NAME}.tar.gz" rpm
          mv -v "apt-repo-${GITHUB_REF_NAME}.tar.gz" dist/
          mv -v "rpm-repo-${GITHUB_REF_NAME}.tar.gz" dist/

      - name: Upload package artifacts
        uses: actions/upload-artifact@v4
        with:
          name: release-packages
          path: |
            dist/*.deb
            dist/*.rpm
            dist/public.gpg
            dist/apt-repo-*.tar.gz
            dist/rpm-repo-*.tar.gz
            dist/apt/**
            dist/rpm/**

  publish:
    name: Sign + publish release + gh-pages
    runs-on: ubuntu-latest
    needs:
      - build-archives
      - linux-packages
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@1.92.0

      - name: Publish to crates.io (optional)
        env:
          CARGO_REGISTRY_TOKEN: ${{ secrets.CRATES_IO_TOKEN }}
        shell: bash
        run: |
          set -euo pipefail
          if [[ -z "${CARGO_REGISTRY_TOKEN}" ]]; then
            echo "CRATES_IO_TOKEN not set; skipping crates.io publish."
            exit 0
          fi
          tag="${GITHUB_REF_NAME}"
          version="${tag#v}"
          crate="debaser"

          cargo_version="$(cargo metadata --no-deps --format-version=1 | python3 -c 'import json,sys; print(json.load(sys.stdin)["packages"][0]["version"])')"
          if [[ "$version" != "$cargo_version" ]]; then
            echo "Tag version ($version) does not match Cargo.toml version ($cargo_version)" >&2
            exit 1
          fi

          if curl -fsSL "https://crates.io/api/v1/crates/${crate}" | python3 -c "import json,sys; v='${version}'; data=json.load(sys.stdin); sys.exit(0 if any(ver.get('num')==v for ver in data.get('versions',[])) else 1)"; then
            echo "${crate} ${version} already published; skipping."
            exit 0
          fi

          cargo publish --locked

      - name: Download archives
        uses: actions/download-artifact@v4
        with:
          pattern: release-archive-*
          merge-multiple: true
          path: dist

      - name: Download packages
        uses: actions/download-artifact@v4
        with:
          name: release-packages
          path: dist-packages

      - name: Collect release assets
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p dist
          find dist-packages/dist -maxdepth 1 -type f -print -exec mv -v {} dist/ \;

      - name: Import GPG signing key
        env:
          GPG_PRIVATE_KEY: ${{ secrets.GPG_PRIVATE_KEY }}
        run: |
          set -euo pipefail
          if [[ -z "${GPG_PRIVATE_KEY}" ]]; then
            echo "Missing GPG_PRIVATE_KEY secret" >&2
            exit 1
          fi
          printf '%s' "${GPG_PRIVATE_KEY}" | base64 --decode | gpg --batch --import

      - name: Generate checksums
        shell: bash
        run: |
          set -euo pipefail
          cd dist
          find . -maxdepth 1 -type f ! -name 'SHA256SUMS*' -print0 \
            | sort -z \
            | xargs -0 sha256sum > SHA256SUMS

      - name: Sign checksums
        shell: bash
        env:
          GPG_PASSPHRASE: ${{ secrets.GPG_PASSPHRASE }}
        run: |
          set -euo pipefail
          key_id="$(gpg --list-secret-keys --with-colons | awk -F: '$1=="fpr" {print $10; exit}')"
          cd dist
          gpg_args=(--batch --yes --pinentry-mode loopback --armor --detach-sign)
          if [[ -n "${GPG_PASSPHRASE}" ]]; then
            gpg_args+=(--passphrase "${GPG_PASSPHRASE}")
          fi
          gpg "${gpg_args[@]}" -u "$key_id" --output SHA256SUMS.sig SHA256SUMS

      - name: Generate Homebrew formula + winget manifests
        shell: bash
        run: |
          set -euo pipefail
          version="${GITHUB_REF_NAME#v}"

          ./scripts/packaging/generate-homebrew-formula.sh \
            --version "${version}" \
            --sha256sums dist/SHA256SUMS \
            --repo "${GITHUB_REPOSITORY}" \
            --output dist/debaser.rb

          rm -rf winget-out
          ./scripts/packaging/generate-winget-manifests.sh \
            --version "${version}" \
            --sha256sums dist/SHA256SUMS \
            --repo "${GITHUB_REPOSITORY}" \
            --output-dir winget-out

          (cd winget-out && zip -r "../dist/winget-manifests-${GITHUB_REF_NAME}.zip" manifests)

      - name: Create GitHub Release (if missing)
        env:
          GH_TOKEN: ${{ github.token }}
        shell: bash
        run: |
          set -euo pipefail
          tag="${GITHUB_REF_NAME}"
          if gh release view "$tag" --repo "$GITHUB_REPOSITORY" >/dev/null 2>&1; then
            echo "Release ${tag} already exists."
            exit 0
          fi
          gh release create "$tag" \
            --repo "$GITHUB_REPOSITORY" \
            --generate-notes

      - name: Upload assets to release
        env:
          GH_TOKEN: ${{ github.token }}
        shell: bash
        run: |
          set -euo pipefail
          gh release upload "${GITHUB_REF_NAME}" dist/* --repo "$GITHUB_REPOSITORY" --clobber

      - name: Prepare gh-pages content
        shell: bash
        run: |
          set -euo pipefail
          owner="${GITHUB_REPOSITORY%%/*}"
          repo="${GITHUB_REPOSITORY##*/}"
          base_url="https://${owner}.github.io/${repo}"

          rm -rf gh-pages-content
          mkdir -p gh-pages-content/apt gh-pages-content/rpm

          cp -R dist-packages/dist/apt/dists gh-pages-content/apt/
          cp -R dist-packages/dist/apt/pool gh-pages-content/apt/
          cp -R dist-packages/dist/rpm/* gh-pages-content/rpm/
          cp dist-packages/dist/public.gpg gh-pages-content/public.gpg
          printf "Types: deb\nURIs: %s/apt\nSuites: stable\nComponents: main\nSigned-By: /usr/share/keyrings/debaser-archive-keyring.gpg\n" \
            "$base_url" > gh-pages-content/debaser.sources

          printf "[debaser]\nname=debaser\nbaseurl=%s/rpm\nenabled=1\nrepo_gpgcheck=1\ngpgcheck=0\ngpgkey=%s/public.gpg\n" \
            "$base_url" "$base_url" > gh-pages-content/debaser.repo

      - name: Publish to gh-pages
        env:
          GH_TOKEN: ${{ github.token }}
        shell: bash
        run: |
          set -euo pipefail
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

          git fetch origin --no-tags
          if git show-ref --verify --quiet refs/remotes/origin/gh-pages; then
            git worktree add gh-pages origin/gh-pages
          else
            git worktree add gh-pages
            (cd gh-pages && git checkout --orphan gh-pages)
          fi

          rsync -a --delete --exclude '.git' gh-pages-content/ gh-pages/

          (cd gh-pages && \
            git add -A && \
            git commit -m "Publish packages for ${GITHUB_REF_NAME}" || true)

          (cd gh-pages && git push origin HEAD:gh-pages)
